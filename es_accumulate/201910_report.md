# 1ã€LogstashæœåŠ¡å¯åŠ¨ä¸ºä»€ä¹ˆä¼šæŠŠElasticsearchæœåŠ¡æ€æ­»ï¼Ÿ
ä½¿ç”¨bin/logstash -e 'input { stdin { } } output { elasticsearch { hosts => ["XX.XXX.XX:9200"] } stdout { codec => rubydebug }}'æ¥å¯åŠ¨æœåŠ¡ï¼Œ
ä¸ºä»€ä¹ˆElasticsearchä¼šæ˜¾ç¤ºKilled

å›å¤ï¼š
logstash éå¸¸è€—è´¹èµ„æºï¼Œä¼°è®¡æ˜¯ä½ çš„eså’Œlogstash éƒ½æŒ‰ç…§åœ¨åŒä¸€å°æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨çš„é…ç½®å¹¶ä¸é«˜ï¼Œæ‰€ä»¥è·‘logstash å°±å¯èƒ½æŠŠeså¼„æŒ‚ã€‚

# 2ã€å¦‚ä½•åˆ¤æ–­Elasticsearchçš„å­—æ®µæ˜¯å¦æ˜¯æ•°ç»„

å›å¤ï¼šElasticsearchæ²¡æœ‰ä¸“é—¨çš„æ•°ç»„ç±»å‹ï¼ŒESåŒä¸€å­—æ®µï¼Œæ™®é€šç±»å‹å’Œæ•°ç»„æ˜¯å¯ä»¥åŒæ—¶å­˜åœ¨ã€‚
è½¬å…¥javaå¯¹è±¡ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰å‡†ç¡®æ¥åˆ¤æ–­è¿™ä¸ªç±»å‹æ˜¯æ•°ç»„è¿˜æ˜¯æ™®é€šç±»å‹ã€‚ç›®å‰æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œjavaå¯¹è±¡ä¸­å¯¹åº”çš„å­—æ®µè®¾ç½®ä¸ºListç±»å‹ï¼Œè¿™æ ·2ç§ç±»å‹éƒ½å¯ä»¥å…¼å®¹ã€‚

# 3ã€DSLè¯­æ³•çš„æ‰§è¡Œé¡ºåº
```
{
    "query":{
        "bool":{
            "must":{
                "match":{
                    "state":"PA"
                }
            },
            "filter":{
                "range":{
                    "age":{
                        "lte":100
                    }
                }
            }
        }
    }
}
```
æ˜¯å…ˆæ‰§è¡Œmatchè¿˜æ˜¯å…ˆæ‰§è¡Œfilterï¼Ÿå†…éƒ¨çš„æ‰§è¡Œé¡ºåºå’Œä»£ç çš„ä¹¦å†™é¡ºåºæœ‰å…³ç³»ä¹ˆï¼Ÿ

å›å¤ï¼š
å®˜æ–¹åšå®¢â€”â€”https://www.elastic.co/cn/blog/elasticsearch-query-execution-order

æ ¸å¿ƒï¼š
Do filters get executed before or after queries?
A: Neither, really. Everything is interleaved, regardless of whether they are queries of filters. 
Conjunctions get executed in a way where the clause with the least cost is used to lead iteration and other clauses are advanced 
to check whether they match too. However we only compute scores when we verified that all clauses match.

# 4ã€Elasticsearché›†ç¾¤è§„åˆ’æ±‚åŠ©

å„ä½å°ä¼™ä¼´å¥½ï¼Œæˆ‘æƒ³è¯·æ•™ä¸€ä¸‹å…³äºé›†ç¾¤è§„åˆ’çš„é—®é¢˜â€¦

æ•°æ®é‡å¤§æ¦‚æœ‰30T(åœ¨å¼€äº†å‰¯æœ¬çš„æƒ…å†µä¸‹)å·¦å³ï¼Œç›®å‰æœ‰7100ä¸ªåˆ†ç‰‡(ç®—ä¸Šäº†å‰¯æœ¬åˆ†ç‰‡)ã€‚

é›†ç¾¤æœ‰15å°æœºå™¨ï¼Œæ¯ä¸ªæœºå™¨çš„å†…å­˜éƒ½æ˜¯125Gã€‚

æˆ‘æ‰“ç®—å•ç‹¬æŠŠä¸€ä¸ªèŠ‚ç‚¹åˆ†ç¦»å‡ºæ¥ï¼Œä½œä¸ºmasterèŠ‚ç‚¹ï¼Œä¹‹åå†å°†ä¸¤ä¸ªèŠ‚ç‚¹ä½œä¸ºåè°ƒèŠ‚ç‚¹ï¼Œå‰©ä¸‹çš„12ä¸ªèŠ‚ç‚¹ï¼Œ6ä¸ªç»™çƒ­æ•°æ®6ä¸ªç»™å†·æ•°æ®åšå†·çƒ­åˆ†ç¦»ã€‚

è¯·é—®ä¸‹å„ä½å°ä¼™ä¼´æˆ‘è¿™ä¸ªè§„åˆ’æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥çš„è¯å¸Œæœ›æŒ‡æ­£ï¼

å¦å¤–æˆ‘æƒ³é—®ä¸€ä¸‹â€¦æˆ‘ç»å¸¸çœ‹åˆ°ç½‘ä¸Šæœ‰äººè¯´è‡ªå·±çš„é›†ç¾¤é‡Œæœ‰2ã€3ä¸ªä¸»èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸»èŠ‚ç‚¹æ— è®ºæœ‰å‡ ä¸ªï¼Œæœ€åä¸è¿˜æ˜¯åªæœ‰ä¸€ä¸ªèƒ½å½“é€‰ä¹ˆï¼Œé‚£è¿™æ ·å¹²è„†æ‹¿ä¸€å°èŠ‚ç‚¹å‡ºæ¥åªåšä¸»èŠ‚ç‚¹ä¸å¥½ä¹ˆï¼Ÿä¸ºå•¥è¿˜è¦ä¿æŒæœ‰2ã€3ä¸ªå‘¢ï¼Ÿæ˜¯æ‹…å¿ƒä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹ˆï¼Ÿ

è¿˜æœ‰å°±æ˜¯ä¸€æ—¦å¼€äº†åè°ƒèŠ‚ç‚¹ï¼Œæ˜¯ä¸æ˜¯æˆ‘çš„ç¨‹åºé‡Œï¼Œè¿æ¥ESé›†ç¾¤çš„ä»£ç å°±å¿…é¡»åªèƒ½è¿æ¥ä¸¤ä¸ªåè°ƒèŠ‚ç‚¹äº†(ä»¥å‰éƒ½æ˜¯ç›´æ¥æŠŠæ‰€æœ‰èŠ‚ç‚¹å†™åœ¨clienté…ç½®é‡Œ)ï¼Ÿ

å›å¤1ï¼š1ï¼Œåˆ†ç‰‡æ•°é‡å¤šå°‘åˆé€‚ï¼Ÿ
æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°æ¨èåœ¨20GB-40GBä¹‹é—´ï¼Œæˆ‘è‡ªå·±ä¸€èˆ¬ä¿è¯å•ä¸ªåˆ†ç‰‡çš„å¤§å°ä¸è¶…è¿‡30GBã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¤šå°‘ä¸ªåˆ†ç‰‡åˆé€‚ï¼Ÿ

è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç»éªŒæ³•åˆ™ï¼šç¡®ä¿å¯¹äºèŠ‚ç‚¹ä¸Šå·²é…ç½®çš„æ¯ä¸ª GBï¼Œå°†åˆ†ç‰‡æ•°é‡ä¿æŒåœ¨ 20 ä»¥ä¸‹ã€‚å¦‚æœæŸä¸ªèŠ‚ç‚¹æ‹¥æœ‰ 30GB çš„å †å†…å­˜ï¼Œé‚£å…¶æœ€å¤šå¯æœ‰ 600 ä¸ªåˆ†ç‰‡ï¼Œä½†æ˜¯åœ¨æ­¤é™å€¼èŒƒå›´å†…ï¼Œæ‚¨è®¾ç½®çš„åˆ†ç‰‡æ•°é‡è¶Šå°‘ï¼Œæ•ˆæœå°±è¶Šå¥½ã€‚

å…·ä½“å‚è€ƒï¼šhow-many-shards-should-i-have-in-my-elasticsearch-cluster
ç²—ç•¥åœ°ç®—ï¼šï¼ˆ30*1024)/7100=4.3GB/åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡çš„å¤§å°ä¸ç®—å¤§ï¼Œèƒ½holdä½ã€‚
å…·ä½“åˆ°ä¸€ä¸ªç´¢å¼•åº”è¯¥é…ç½®å¤šå°‘ä¸ªä¸»åˆ†ç‰‡ï¼Œå¤šå°‘ä¸ªå‰¯æœ¬åˆ†ç‰‡ï¼Ÿè€ƒè™‘ä¸€ä¸‹è¿™ä¸ªç´¢å¼•æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Ÿè¿™ä¸ªç´¢å¼•çš„Mappingç»“æ„å¦‚ä½•å®šä¹‰ï¼Ÿ
å“ªäº›å­—æ®µéœ€è¦åšæœç´¢(index_optionså‚æ•°)ï¼Ÿå“ªäº›å­—æ®µåštermæŸ¥è¯¢(keyword ç±»å‹)ã€å“ªäº›å­—æ®µéœ€è¦AnalyzeråšMatchæŸ¥è¯¢(text ç±»å‹)ã€è¦ä¸è¦èšåˆ(æ˜¯å¦å¼€å¯doc_value)ï¼Œè¦ä¸è¦è¯­æ³•é«˜äº®(term_vector å’Œ positions å‚æ•°)ï¼Œè¦ä¸è¦ç¦ç”¨_sourceå‚æ•°ï¼Ÿ
ä¸€ä¸ªåˆç†çš„Mappingé…ç½®ä¹Ÿæ˜¯èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘index å¤§å°çš„ã€‚æˆ‘ä»¬å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç¦ç”¨doc_valueä¹‹åï¼Œç´¢å¼•å¤§å°å‡ ä¹å‡å°äº†ä¸€åŠã€‚
 
 åƒè¿™ç§128GBå¤§å†…å­˜çš„æœºå™¨ï¼ŒESå®˜æ–¹æ–‡æ¡£heap sizeé‡Œé¢æœ‰è¯´ï¼šESè¿›ç¨‹æ‰€ä½¿ç”¨çš„ç‰©ç†å†…å­˜(Xms Xmxé…ç½®)ä¸è¦è¶…è¿‡æœºå™¨ç‰©ç†å†…å­˜çš„ä¸€åŠï¼Œ
 åŒæ—¶è€ƒè™‘åˆ°æŒ‡é’ˆå‹ç¼©é—®é¢˜ï¼Œåˆ†é…ç»™ESè¿›ç¨‹çš„å†…å­˜ä¸è¦è¶…è¿‡32GBï¼Œä¸€ä¸ªå®‰å…¨çš„å€¼æ˜¯26GBï¼ˆå„ä¸ªæ“ä½œç³»ç»Ÿå¹³å°ä¸Šï¼ŒJVMè¿›ç¨‹26GBä¸ä¼šæœ‰æŒ‡é’ˆå‹ç¼©é—®é¢˜ï¼‰
å…·ä½“å‚è€ƒï¼šheap-size

2ï¼Œå…³äºä¸»èŠ‚ç‚¹ä¸ªæ•°çš„é—®é¢˜
"ç½‘ä¸Šè¯´çš„é…ç½®3ä¸ªä¸»èŠ‚ç‚¹"ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼š3ä¸ª master eligible node ï¼ˆæœ‰èµ„æ ¼æˆåŠŸmasterèŠ‚ç‚¹ï¼‰ï¼Œé€šä¿—åœ°è®²ï¼Œå°±æ˜¯æ‹¿3å°æœºå™¨å‡ºæ¥ï¼Œ
ä¸å­˜å‚¨æ•°æ®(node.data=false)ï¼Œä¸“é—¨ç”¨æ¥åšmasteré€‰ä¸¾ç”¨(dedicated master eligible node)ï¼Œé€‰ä¸¾ç»“æœè‚¯å®šåªèƒ½æ˜¯ï¼šå…¶ä¸­æŸå°èŠ‚ç‚¹æˆä¸ºmasterèŠ‚ç‚¹ã€‚
å¦‚æœæ•´ä¸ªé›†ç¾¤ä¸­åªæœ‰ä¸€å°èŠ‚ç‚¹èƒ½å¤Ÿæˆä¸ºmasterèŠ‚ç‚¹ï¼Œå°±ä¼šå­˜åœ¨å•ç‚¹æ•…éšœï¼Œå¦‚æœmasterèŠ‚ç‚¹å®•æœºï¼Œæ•´ä¸ªé›†ç¾¤å°±å†æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹èƒ½å¤Ÿè¢«é€‰ä¸¾ä¸ºmasteräº†ï¼Œä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šé…ç½®å¤šä¸ª node.master: true
å…³äºElasticSearchå„ä¸ªèŠ‚ç‚¹æ‰€èµ·çš„è§’è‰²ï¼Œå¯å‚è€ƒï¼šmodules-node
 
3ï¼Œclientè¿æ¥åè°ƒèŠ‚ç‚¹é—®é¢˜
è¿™ä¸ªè¿˜æ˜¯èŠ‚ç‚¹çš„è§’è‰²é—®é¢˜ã€‚å¯å‚è€ƒç¬¬2ç‚¹ä¸­ç»™å‡ºçš„å‚è€ƒé“¾æ¥ã€‚æ³¨æ„è¿™å¥è¯ï¼š"Every node is implicitly a coordinating node."ï¼Œå¦‚æœè¦å•ç‹¬æ‹¿2å°å‡ºæ¥åšåè°ƒèŠ‚ç‚¹ï¼Œ
éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œé¢è¿™æ ·é…ç½®ï¼š
node.master: false
node.data: false
node.ingest: false
åè°ƒèŠ‚ç‚¹ä½œç”¨ï¼šå°†æœç´¢è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šï¼›å°†å„ä¸ªèŠ‚ç‚¹ä¸Šæœç´¢ç»“æœå†æ¬¡æ’åºæ±‡æ€»æˆæœ€ç»ˆç»“æœï¼ˆquery_then_fetch æŸ¥è¯¢ç±»å‹ï¼‰
 
å…¶å®æˆ‘è§‰å¾—ï¼Œè®©æ¯ä¸ªèŠ‚ç‚¹å•ç‹¬æ‰®æ¼”æŸä¸ªè§’è‰²(master eligible node ã€data nodeã€coordinatoring node) ä¸»è¦è¿˜æ˜¯ä¸ºäº†é›†ç¾¤ç¨³å®šå§ï¼Œå„ä¸ªåŠŸèƒ½æ¨¡å—å„å¸å…¶èŒï¼Œ
æœ€å¥½äº’ä¸å½±å“ã€‚

å›å¤2ï¼š
1.å­˜åœ¨15å°ä¸»æœºï¼Œæ¯å°ä¸»æœºå­˜åœ¨æœ‰126Gçš„å¤§å°ï¼Œå…¶å®è¿™ç§æƒ…å†µå¯ä»¥è€ƒè™‘æ¯ä¸ªä¸»æœºå¤šeså®ä¾‹è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ›´åŠ åˆç†çš„åˆ©ç”¨ä¸»æœºçš„å†…å­˜
2.å†·çƒ­åˆ†ç¦»çš„æœ¬è´¨å®é™…ä¸Šæ˜¯ä¸ºäº†æŠŠç»å¸¸æœç´¢çš„æ•°æ®æ”¾åˆ°ioæ›´å¥½ï¼Œæ€§èƒ½æ›´å¥½çš„ç£ç›˜ä¸Šï¼Œè¿™é‡Œé¢è¦å–å†³äºä¸»æœºä¸Šæ˜¯å­˜åœ¨ä¸åŒçš„æ€§èƒ½ç£ç›˜è¿˜æ˜¯ä¸»æœºæœ‰ä¸åŒç£ç›˜çš„æ€§èƒ½æ•°æ®æ¥çœ‹ï¼Œ
å¯ä»¥é‡‡ç”¨å¤šå®ä¾‹æŒ‚åœ¨ä¸åŒçš„ç›®å½•ï¼Œå°†çƒ­ç´¢å¼•çš„æ•°æ®æŒ‰ç…§tagå°†åˆ†ç‰‡å­˜æ”¾åˆ°ioæ›´å¥½çš„ç£ç›˜ä¸­ï¼Œå†ä½¿ç”¨curatorä¹‹ç±»çš„å·¥å…·æˆ–è€…esåŸç”Ÿçš„moveä¹‹ç±»çš„apiè¿›è¡Œçƒ­çƒ­å†·æ•°æ®çš„è¿ç§»
 3.å¦å¤–éœ€è¦çœ‹å®æ—¶å†™å…¥esçš„ç´¢å¼•çš„æ•°æ®ï¼Œå¦‚æœåªæœ‰1ä¸ªç´¢å¼•æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç›´æ¥å‡è¡¡å°†ç´¢å¼•çš„åˆ†ç‰‡å‡è¡¡åˆ†å¸ƒï¼Œå¦‚æœå®æ—¶äº§ç”Ÿçš„ç´¢å¼•æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œ
 æ¯ä¸ªç´¢å¼•ç”±äºå¤§å°ä¸ä¸€è‡´åˆ†ç‰‡é…ç½®ä¹Ÿä¸ä¸€æ ·ï¼Œéœ€è¦æœ‰1ä¸ªåˆç†çš„æœºåˆ¶å°†å…¨éƒ¨çš„åˆ†ç‰‡å‡è¡¡åˆ†å¸ƒ
 
 # 5ã€å¤šç§åœºæ™¯ä¸‹çš„èåˆæœç´¢æœ‰ä»€ä¹ˆæ¯”è¾ƒåˆç†çš„æ–¹æ¡ˆå‘¢ï¼Ÿ
 
 æ¯”å¦‚æœ‰ä¸‰ç§æ•°æ®`è”ç³»äºº`ã€`æ–°é—»`ã€`é¡¹ç›®æ–‡æ¡£`ï¼Œæœç´¢`ç‹ä¼Ÿ`ï¼Œåœ¨ä¸‰ç§æ•°æ®ä¸­éƒ½ä¼šæœ‰å‡ºç°ã€‚
 
é—®é¢˜æœ‰:
1. ä¸åŒæ•°æ®ç‹¬ç«‹ç´¢å¼•ï¼Œè¿˜æ˜¯æœ‰ä¸€ä¸ª`ç»¼åˆç´¢å¼•`ï¼Ÿ
2. ä¸æ–­æœ‰æ–°åœºæ™¯å¼•å…¥çš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆæ§åˆ¶æœç´¢èŒƒå›´ï¼Ÿ
3. ä¸åŒæ•°æ®é‡çº§å·®å¼‚è¾ƒå¤§ï¼Œå¦‚ä½•è®¾è®¡ç´¢å¼•åˆ‡å‰²æ¯”è¾ƒåˆç†ï¼Ÿ

å›å¤ï¼š

ä¸ºäº†ä½è€¦åˆï¼Œå»ºè®®åˆ†ç´¢å¼•ï¼Œé—®é¢˜2å’Œ3ä¹Ÿæ²¡äº†ã€‚åŒæ—¶åŠ¡å¿…åšå¥½ä»¥ä¸‹ä¸¤ç‚¹ï¼š
ï¼ˆ1ï¼‰ä¿æŒå¥½â€œä¸€åœºæ™¯ä¸€ç´¢å¼•â€çš„åŸåˆ™ã€‚
ï¼ˆ2ï¼‰æ‰€æœ‰ç´¢å¼•å­—æ®µå¯¹é½ï¼Œæ²¡æœ‰æ•°æ®çš„å­—æ®µç½®ç©ºè€Œénullå€¼ã€‚
ä¸æŒ‰ä¸Šé¢åšï¼Œåç»­ä¼šæœ‰ä»¥ä¸‹ç—›ç‚¹ï¼š
ï¼ˆ1ï¼‰â€œå¤šåœºæ™¯ä¸€ç´¢å¼•â€å¾ˆå¤šäººä¼šæœ‰typeåŒºåˆ†ç´¢å¼•ï¼Œè¿™æ ·ä¼šå¯¼è‡´æŸ¥è¯¢æ—¶åšä¸äº†ä»¥ç´¢å¼•åŒºåˆ†æƒé‡ã€‚æ¯”å¦‚ä½ æƒ³è®©â€œè”ç³»äººâ€æƒé‡æ›´é«˜ï¼Œä¸€ç´¢å¼•æƒ…å†µä¸‹åšä¸äº†ï¼ˆå¯ä»¥åšï¼Œä½†æ¯”è¾ƒéº»çƒ¦ï¼‰ã€‚
ï¼ˆ2ï¼‰å¤šç´¢å¼•æ²¡å¯¹é½å­—æ®µä»¥åŠæ²¡æœ‰æ•°æ®çš„å­—æ®µä¸ç½®ç©ºè€Œæ˜¯nullå€¼ï¼ŒæŸ¥è¯¢æ—¶script_scoreä¼šæŠ¥é”™ã€‚æ¯”å¦‚_search/index1,index2æ—¶ï¼Œindex2é‡Œæ²¡æœ‰æŸä¸ªå­—æ®µæˆ–æŸå­—æ®µæ˜¯nullï¼Œscript_scoreéƒ½ä¼šæŠ¥é”™å¯¼è‡´æŸ¥è¯¢è¯·æ±‚å¤±è´¥ã€‚
æ‰€ä»¥ä¸€å¼€å§‹å°±åšå¥½è§„èŒƒå§ï¼Œæ›¾ESæ¥å…¥è¿‡100+ä¸ªåœºæ™¯çš„å»ºè®®ã€‚

https://elasticsearch.cn/question/8486

# 6ã€ES Aggsæ ¹æ®èšåˆçš„ç»“æœï¼ˆæ•°å€¼ï¼‰è¿›è¡Œè¿‡æ»¤

èšåˆå®æ“æ¡ˆä¾‹ï¼šhttps://elasticsearch.cn/article/13501

# 7ã€elastic search å¦‚ä½•å‘listå­—æ®µé‡Œé¢è¿½åŠ æ•°æ®

```
POST test/_doc
{
  "f1": ["d1"]
}


POST test/_doc/_update_by_query?pretty
{
  "script": {
    "inline": "ctx._source.f1.add(params.hits)",
    "params": {
      "hits": "d2"
    }
  },
  "query": {
    "match_all": {}
  }
}

GET test/_search
```

# 8ã€ã€é‡è¦ã€‘Elasticsearchå‡çº§åå¦‚ä½•å›æ»šï¼Ÿ
ES6.1å‡çº§åˆ°6.7ç‰ˆæœ¬åï¼ˆç›´æ¥æ›¿æ¢äºŒè¿›åˆ¶ï¼‰ï¼ŒæœåŠ¡æ­£å¸¸ã€‚ä½†å¦‚æœæƒ³å›é€€åˆ°6.1ç‰ˆæœ¬ï¼Œå‘ç°æ•°æ®æ–‡ä»¶å†…å®¹ã€ç»“æ„éƒ½æœ‰è°ƒæ•´ï¼Œå†å²ç‰ˆæœ¬ä¸è¯†åˆ«ï¼Œ
é™¤äº†å¤‡ä»½ä¹‹å¤–ï¼Œè¿˜æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥é™çº§å—ï¼Ÿ

å›å¤ï¼š
ç‰ˆæœ¬å‡çº§ç›´æ¥æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ“ä½œ....å¿ƒå¤ªå¤§äº†ã€‚
æ­£è§„æ–¹å¼ï¼šæ•°æ®å¤‡ä»½ã€éƒ¨ç½²æ–°ç‰ˆæœ¬ESé›†ç¾¤ã€é‡å»ºç´¢å¼•ã€‚
ç‰¹åˆ«æ˜¯æ¶‰åŠå¤§ç‰ˆæœ¬æ›´æ–°ï¼Œmappingã€æŸ¥è¯¢DSLã€æ’ä»¶å¾ˆå¤šè¦è·Ÿç€ä¸€èµ·ä¿®æ”¹ã€‚
https://elasticsearch.cn/question/8495

# 9ã€æ–°æ‰‹æ±‚æ•™ï¼Œè¿™ç§æ•°æ®é€‚åˆESå¤„ç†ä¹ˆï¼Ÿ

æ¯”å¦‚ï¼Œæˆ‘æœ‰10ä¸ªcsvæ–‡ä»¶ï¼Œæœ‰ç€ä¸åŒçš„å­—æ®µç»“æ„ï¼Œé€šè¿‡ä¸€ä¸ªUIDå­—æ®µå°†ä»–ä»¬å…³è”èµ·æ¥ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·
test1.csvç»“æ„
UID,FieldA,FieldB,FieldC
1,AAA,BBB,CCC
 
test2.csvç»“æ„
UID,FieldD,FieldE,FieldF
1,DDD,EEE,FFF
 
ä¸çŸ¥é“è¿™ç§æ•°æ®é€‚åˆELKå¤„ç†ä¹ˆï¼Ÿç°åœ¨çš„æƒ³æ³•æ˜¯æŠŠ10ä¸ªcsvå¯¼å…¥åˆ°10ä¸ªç´¢å¼•ï¼Œå› ä¸ºæŸ¥è¯¢æ¶‰åŠåˆ°é€šè¿‡UIDå…³è”æŸ¥è¯¢ï¼Œ
ESæ–¹ä¾¿åšåˆ°è¿™ç§å…³è”æŸ¥è¯¢ä¹ˆï¼Ÿä¹Ÿä¸çŸ¥é“è¿™ç§åšæ³•æ˜¯å¦æ­£ç¡®ã€‚è¿˜æ˜¯è¯´è¦å°†10ä¸ªcsvçš„å­—æ®µåˆå¹¶æˆ1ä¸ªç´¢å¼•æ¥å­˜ï¼Ÿ

å›å¤ï¼š
å…³ç³»å‹æ•°æ®åº“è½¬åˆ°ESï¼Œå¤§å¤šä¼šæ¶‰åŠå¤šè¡¨æŸ¥è¯¢çš„é—®é¢˜ï¼Œæƒ³åšåˆ°åƒsqlé‚£æ ·çš„è”åˆæŸ¥è¯¢ï¼Œä¸€èˆ¬4ç§æ–¹æ³•:
1. å¤šä¸ªç´¢å¼•åº“ï¼Œjavaå®¢æˆ·ç«¯å®ç°æŸ¥è¯¢è”åˆï¼Œä½¿ç”¨äºæ•°æ®é‡å¾ˆå°ï¼Œå¤šæ¬¡å»è¯·æ±‚ï¼Œå®¢æˆ·ç«¯æ•´åˆè¿”å›ç»“æœã€‚è¿™ä¸ªå±€é™æ€§å¾ˆå¤§ã€‚
esæ²¡æœ‰ç´¢å¼•åº“ä¹‹é—´çš„å…³è”æŸ¥è¯¢ï¼Œä¸‹é¢éƒ½æ˜¯ä¸€ä¸ªè¡¨ï¼Œæ¥å®ç°è”åˆæŸ¥è¯¢ï¼›

2.å®½è¡¨ï¼Œæ‰€æœ‰å±‚æ•°æ®éƒ½å±•å¼€ï¼›æŸ¥è¯¢æ–¹ä¾¿ï¼Œä½†æ˜¯ç»´æŠ¤éº»çƒ¦ï¼Œåˆ é™¤å’Œä¿®æ”¹æœ‰è¯¸å¤šä¸å˜ï¼›è€Œä¸”å ç”¨ç©ºé—´å¤§ã€‚

3.åµŒå¥—;1å¯¹å¤šï¼Œå¤šå¯¹å¤šéƒ½å¯ä»¥å®ç°ï¼›ä½†æ˜¯åµŒå¥—å±‚æ•°ä¸è¦å¤ªæ·±ï¼›æ›´æ–°æ•°æ®æ—¶ï¼Œæ˜¯æ•´ä¸ªæ–‡æ¡£éƒ½è¦æ›´æ–°ç´¢å¼•ï¼Œæ›´æ–°ä¸èƒ½å¤ªé¢‘ç¹ï¼›å…³è”å°±é åµŒå¥—å…³ç³»ï¼Œæ²¡æœ‰ä»€ä¹ˆå…³è”å¼€é”€

4.çˆ¶å­æ–‡æ¡£:çˆ¶ä¸å­æ–‡æ¡£åˆ†å¼€ï¼Œjoinå­—æ®µçš„å…³ç³»è¿æ¥ï¼Œè¿™ä¸ªæœ€åƒsqlï¼›å…³è”æŸ¥è¯¢ä¹Ÿæœ‰å·¨å¤§çš„æ€§èƒ½å¼€é”€ï¼›
 
å…·ä½“åˆ°ä½ çš„10çš„è¡¨ï¼š1. èƒ½åˆå¹¶çš„åˆå¹¶ï¼Œåƒid+nameè¿™ç±»çš„å°è¡¨åˆå¹¶åˆ°å¤§è¡¨é‡Œé¢ï¼›
                              2.1å¯¹å¤šï¼Œå¤šå¯¹å¤šï¼Œå¾ˆå°‘ä¿®æ”¹çš„åšå¥½ä½¿ç”¨åµŒå¥—ï¼Œåƒè®¢å•ä¸è®¢å•é¡¹è¿™æ ·çš„è¡¨ï¼Œï¼›
                              3.è¡¨å…³ç³»è¿›ä¸€æ­¥åˆ†æï¼Œæ²¡ä»€ä¹ˆå…³è”çš„æ‹†åˆ†å‡ºå»ï¼›
ä¸æ˜¯è¯´10ä¸ªå°±å»º10ä¸ªç´¢å¼•ï¼Œæˆ–è€…åˆèµ·æ¥å»º1ä¸ªï¼›å…·ä½“è¿˜æ˜¯éœ€è¦çœ‹è¡¨ä¸è¡¨çš„å…³ç³»ï¼›åšä¸åŒåŒºåˆ†ï¼›
 
 # 10ã€å¦‚ä½•å¯¹ç›¸å…³åº¦åˆ†è¿›è¡Œå½’ä¸€?
 
 å¦‚ä¸‹é¢çš„æŸ¥è¯¢è¯­å¥ï¼Œæˆ‘æƒ³åœ¨æ–‡æœ¬åŒ¹é…åˆ†çš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªç±»ç›®é¢„æµ‹çš„åˆ†æ•°ã€‚ä½†æ˜¯ç±»ç›®é¢„æµ‹çš„åˆ†æ•°æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œè€Œæ–‡æœ¬åŒ¹é…çš„åˆ†æ•°å˜åŒ–å¹…åº¦å¯èƒ½å¾ˆå¤§ï¼Œ
 è¿™å°±å¯¼è‡´ç±»ç›®é¢„æµ‹çš„åˆ†æ•°æƒé‡ä¸å¥½ç¡®å®šã€‚å› æ­¤æˆ‘æƒ³å¯¹ä¸»æŸ¥è¯¢çš„åˆ†æ•°è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œè¯·é—®åœ¨script_scoreé‡Œé¢èƒ½å¦è·å–åˆ°queryçš„æœ€å¤§åˆ†æ•°max_score? 
 æˆ–è€…æ˜¯å¦æœ‰å…¶ä»–çš„æ–¹æ³•èƒ½å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Ÿ 
 
 medclå›å¤ï¼š
 max_score æ²¡æœ‰åŠæ³•åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡é‡Œé¢å¾—åˆ°ï¼Œä½ ç”¨ decay function æ¥å¹³æ»‘å¾—åˆ†çš„åŒºé—´å¯èƒ½æ›´å¥½ã€‚
 
 https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#_supported_decay_functions
 
 # 11ã€kibanaä¸­è®¾ç½®é€šè¿‡å¾®ä¿¡æŠ¥è­¦
 
 è‡ªå·±ç¼–å†™ä¸€ä¸ªèƒ½å¤Ÿé€šè¿‡å¾®ä¿¡å…¬ä¼—å·/ä¼ä¸šå·å‘æ¶ˆæ¯çš„ç¨‹åºï¼Œç»™ä¸€ä¸ªhttp restfulæ¥å£å‡ºæ¥ã€‚
ç„¶åwatcheré€šè¿‡httpè§¦å‘è¿™ä¸ªæ¥å£å°±å¥½äº†ã€‚æ•°æ®æ ¼å¼ä½ å¯ä»¥è‡ªå·±å®šä¹‰ã€‚

# 12ã€ElasticSearchå¦‚ä½•å¹³ç¨³çš„åšæ•°æ®è¿ç§»ï¼Ÿ

é˜¿é‡Œäº‘çš„è¿ç§»å¾ˆè¯¦ç»†ï¼šhttps://help.aliyun.com/knowledge_detail/61145.html?spm=5176.13394938.0.0.291d1f7cj7x0Mr
å€ŸåŠ©ï¼šreindex è„šæœ¬å®ç°ã€‚

å…¶ä»–é“­æ¯…æ¨èï¼šelasticdump

# 13ã€ã€æ¨èã€‘ä¸è§„åˆ™çš„äº§å“ç¼–å·è¯¥å¦‚ä½•è¿›è¡Œåˆ†è¯å‘¢

æœ‰å•†å“ç¼–å·idæ˜¯ä¸€äº›å­—æ¯åŠ æ•°å­—åŠ ç¬¦å·ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œè¯¥å¦‚ä½•è¿›è¡Œåˆ†è¯ï¼Ÿ
 
ä¾‹å¦‚id æ˜¯ STM8_S003F3P6  è¾“å…¥  STM8_S003F3P6ï¼ŒSTM8ï¼ŒS003F3P6ï¼ŒS003ï¼ŒF3P6  éƒ½èƒ½æœç´¢å‡ºæ¥ç»“æœæ¥
 
å†™äº†ä¸ªngram è®©å®ƒç±»ä¼¼å»ç©·ä¸¾çš„ç´¢å¼•åˆ†è¯ï¼Œç„¶åæœç´¢åˆ†è¯å°±ç®€å•ä¸€äº›ï¼Œ è¿™æ ·å­çš„åšæ³•æ˜¯å¯è¡Œï¼Œæˆ–è€…è¿˜æœ‰æ›´å¥½çš„åŠæ³•å—ï¼Ÿ
 ```
 "tokenizer": {
        "ngram_tokenizer": {
          "type": "ngram",
          "min_gram": 3,
          "max_gram": 10,
          "token_chars": [
            "letter",
            "digit"
          ]
        }
      }
      
       "analyzer": {
        "index_analyzer": {
          "tokenizer": "ngram_tokenizer",
          "filter": [
            "lowercase"
          ]
        },
        "search_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": [
            "lowercase"
          ]
        }
      }
    }
  ```
  
  medclå›å¤ï¼šå¯è¡Œï¼Œå‰ç¼€æŸ¥è¯¢å¤šçš„è¯ï¼Œå¯ä»¥å†é…ä¸€ä¸ª edge_ngram
  https://elasticsearch.cn/question/8547
  
  # 14ã€ã€æ›´æ–°åœºæ™¯ã€‘es5.3.2ç‰ˆæœ¬ï¼Œç›®å‰æœ‰ä¸šåŠ¡éœ€æ±‚æ¯å¤©24ä¸æ–­æ›´æ–°esæ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µï¼Œå¯¼è‡´esæ›´æ–°æ•ˆç‡è¶Šæ¥è¶Šæ…¢
  
  ç›®å‰æœ‰éœ€æ±‚è¦æ¯å¤©24å°æ—¶ä¸æ–­æ›´æ–°esæ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µï¼ˆå¤„ç†æ–‡ç« çš„ç›¸ä¼¼é—®é¢˜ï¼Œç»™ç›¸ä¼¼ç³»åˆ—çš„æœ€æ–°æ–‡ç« æ‰“æ ‡è¯†ï¼‰ï¼Œæ¨¡å‹ç”¨çš„nestedã€‚
  ç”¨çš„æ‰¹é‡æ›´æ–°çš„apiè¿›è¡Œçš„ï¼Œé¢‘ç¹æ›´æ–°ä¸€æ®µæ—¶é—´åå‘ç°esæ›´æ–°é€Ÿåº¦è¶Šæ¥è¶Šæ…¢ï¼Œæµ‹è¯•å‘ç°åˆšå¼€å§‹æ›´æ–°äº”ä¸ªidè¿˜åªæœ‰0.2ç§’å·¦å³ï¼Œ
  è¿ç»­å¤šç‚¹å‡ æ¬¡æ›´æ–°äº”ä¸ªidæœ€åå‡ æ¬¡ä¼šèŠ±è´¹3ç§’å·¦å³ï¼Œ
  å„ä½å¤§ä½¬æœ‰æœ¨æœ‰ä»€ä¹ˆå¥½æ–¹æ³•æˆ–è€…æ–°æ€è·¯ã€‚
  
  ã€å›å¤ã€‘
å¯ä»¥é€šè¿‡hot_thread (https://www.elastic.co/guide/e ... s.html) çœ‹çœ‹æ€§èƒ½ä¸»è¦å¡åœ¨å“ªé‡Œäº†

éšç€æ–‡æ¡£è¶Šæ¥è¶Šå¤šï¼Œæ›´æ–°çš„ä»£ä»·è¶Šæ¥è¶Šå¤§ï¼ŒESä¸å¤ªé€‚åˆé¢‘ç¹æ›´æ–°çš„åœºæ™¯

é“­æ¯…ï¼šè¿™ä¸ªé—®é¢˜éœ€è¦ç»“åˆå®é™…ä¸šåŠ¡ï¼Œå¥½å¥½è®¨è®ºä¸€ä¸‹ã€‚ æº¯æºä¸ºä»€ä¹ˆESä¸æ”¯æŒé¢‘ç¹æ›´æ–°ï¼Ÿ

# 15ã€æ•°æ®é‡å°ï¼Œæ€§èƒ½è¦æ±‚é«˜ï¼Œæ±‚æ¨èé›†ç¾¤é…ç½®

å°ç™½æ±‚åŠ©ï¼Œä¸‹é¢è¿™ç§éœ€æ±‚å¦‚ä½•æ­å»ºé›†ç¾¤æ¯”è¾ƒåˆé€‚
1ï¼‰200ä¸‡æ•°æ®ï¼Œæ’åºæŸ¥è¯¢ã€ å¹¶å‘500 + 200ä¸‡æ•°æ®æŒ‰ä¸€ä¸ªæŒ‡æ ‡èšåˆï¼ˆå¤§æ¦‚åˆ°4ä¸ªèšåˆåˆ°ä¸€ä¸ªï¼‰ï¼Œå¹¶å‘500 ï¼š
2ï¼‰400ä¸‡æ•°æ®ï¼Œ æ’åºæŸ¥è¯¢ï¼Œ å¹¶å‘1200+ 400ä¸‡æ•°æ®æŒ‰ä¸€ä¸ªæŒ‡æ ‡èšåˆï¼ˆå¤§æ¦‚åˆ°4ä¸ªèšåˆåˆ°ä¸€ä¸ªï¼‰ï¼Œå¹¶å‘1200 ï¼š

å›å¤ï¼š
è¯„ä¼°é›†ç¾¤è§„æ¨¡è€ƒè™‘çš„å› ç´ ï¼š
1ã€å½“å‰å­˜å‚¨ï¼šæ•°æ®æ€»é‡â€”â€”æœ‰æä¾› 400W
2ã€æœªæ¥å­˜å‚¨ï¼šæ•°æ®å¢é‡
éœ€è¦é›†åˆ1,2ï¼Œéœ€è¦ä½ è¡¥å……ï¼šå•æ¡æ•°æ®å¤§å°ï¼Œç»™å‡ºæ•°æ®å æ®çš„å­˜å‚¨å¤§å°ï¼Œå¹¶ä¸”é¢„ç•™æœªæ¥æ‰©å±•ï¼Ÿ
3ã€æ€§èƒ½æŒ‡æ ‡ï¼Œä½ æœ‰æåˆ°å¹¶å‘1200â€”â€”å¯¹cpuæœ‰è¾ƒé«˜è¦æ±‚
4ã€å¤æ‚åŠŸèƒ½ï¼Œä½ æœ‰æåˆ°ä¸€ä¸ªæŒ‡æ ‡èšåˆâ€”â€”ä¸ç®—å¤æ‚ï¼Œå†…å­˜é€‚ä¸­å°±èƒ½æå®š
 
ä½ å¯ä»¥æ‹¿åˆ°æœºå™¨åï¼Œå€ŸåŠ©ï¼šesrallyè·‘ä¸€ä¸‹æ€§èƒ½ï¼Œç»“åˆå®é™…ç¡¬ä»¶æ€§èƒ½ä¸ºå‡†ã€‚

# 16ã€esé«˜äº®åœ¨é¡¹ç›®ä¸­è¯¥æ€ä¹ˆä½¿ç”¨ï¼Ÿ

æˆ‘å‘ç°é«˜äº®ä¼šä½œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå•ç‹¬è¿”å›ï¼Œä¸ä¼šæ”¹å˜sourceä¸­çš„å€¼ï¼Œé‚£æˆ‘è¿”å›åˆ°å‰ç«¯ï¼Œè¯¥æ€ä¹ˆæ˜¾ç¤ºå‘¢ï¼Ÿå‰ç«¯è¦å±•ç¤ºè¯¥å­—æ®µï¼Œ
å–sourceé‡Œçš„å€¼å§ï¼Œæ²¡é«˜äº®æ ‡ç­¾ï¼Œå–é«˜äº®å¯¹è±¡çš„å€¼å§ï¼Œåˆç¼ºå¤±æœªé«˜äº®çš„æ•°æ®ï¼Œå› ä¸ºè¯¥å­—æ®µæ˜¯å¤šå€¼ã€‚é‚£ä¹ˆé«˜äº®åŠŸèƒ½åˆ°åº•è¯¥æ€æ ·ç”¨å‘¢ï¼Ÿ

https://elasticsearch.cn/question/8564

å®˜æ–¹ä¸æ”¯æŒè¿™ç§æ–¹å¼ï¼Œå‡ å¹´å‰å°±æœ‰äººæbugï¼Œå®˜æ–¹æ²¡æœ‰è§£å†³ã€‚
https://github.com/elastic/elasticsearch/issues/7416
 
ç½‘å‹çš„å®ç°æ›¿ä»£æ–¹æ¡ˆï¼š

[ "1", "2", "3" ] [ "Alice", "John Doe", "Bob" 
]instead of using objects with ID
[{id:"1", name: "Alice"}, {id:"2", name: "John Doe"}, {id: "3", name:"Bob"} ]

# 17ã€Elasticsearchï¼šinverted indexï¼Œdoc_valuesåŠsource

Elasticsearchçš„æ¯ä¸ªshardé‡Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªLuceneçš„ç´¢å¼•ã€‚
åœ¨è¿™ä¸ªç´¢å¼•é‡Œï¼Œå®ƒåŒ…å«æ¯ä¸ªæ–‡æ¡£çš„inverted index, doc_valuesåŠsourceã€‚
åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç®¡ç†å®ƒä»¬ï¼Œæ¯”å¦‚å¯¹æœ‰çš„å­—æ®µä¸è¿›è¡Œç´¢å¼•ï¼Œæˆ–è€…ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œä¸å­˜å‚¨doc_valuesï¼Œå¯¹äºæŸäº›å­—æ®µä¸è¿›è¡Œå­˜å‚¨ç­‰

https://blog.csdn.net/UbuntuTouch/article/details/102642703

# 18ã€ESç›¸å…³åº¦è¯„åˆ†ä¸ç¬¦åˆé¢„æœŸ

ESç›¸å…³åº¦è¯„åˆ†æœ‰ä¸‰ä¸ªå‚æ•°ä¸å¤ªæ˜ç™½ï¼Œæˆ‘å½•å…¥äº†ä¸¤æ¡æ•°æ®ï¼Œåˆ†åˆ«ä¸ºï¼š
{"id":"2","enName":"bad apple can't be eaten"}ã€{"id":"1","enName":"bad apple"}ï¼Œ
æ ¹æ®ç›¸å…³èµ„æ–™ï¼Œä¸€ä¸ªå­—æ®µåŒ…å«çš„è¯é¡¹æ•°è¶Šå°‘ï¼Œå¾—åˆ†è¶Šé«˜ï¼Œæ‰€ä»¥æˆ‘ä»¥ä¸ºæœç´¢"apple"çš„æ—¶å€™ï¼Œidä¸º1çš„æ•°æ®å¾—åˆ†ä¼šé«˜äºidä¸º2çš„æ•°æ®ï¼Œ
ä½†æ˜¯æœ€ç»ˆç»“æœä¸¤æ¡æ•°æ®å¾—åˆ†ä¸€è‡´ã€‚æŸ¥çœ‹è¯é¢‘(TF)æ‰“åˆ†å…¬å¼(freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength))ï¼Œ
å‘ç°fieldLengthå’ŒavgFieldLengthå§‹ç»ˆç›¸ç­‰ï¼Œè¿™å¯¼è‡´ä¸ç®¡å­—æ®µæœ‰å¤šé•¿ï¼Œæœ€ç»ˆå€¼éƒ½æ˜¯1.0ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ
å¦å¤–æŸ¥çœ‹é€†æ–‡æ¡£é¢‘ç‡(IDF)ï¼Œå‘ç°è¯­æ–™åº“çš„æ–‡æ¡£æ€»æ•°(docCount)å’ŒåŒ…å«è¯¥è¯çš„æ–‡æ¡£æ•°(docFreq)ä¹Ÿæ°¸è¿œä¸º1.0ã€‚å„ä½å¤§ä½¬æœ‰çŸ¥é“æ€ä¹ˆå›äº‹çš„å—ï¼Ÿ

å›å¤ï¼š
æ‰“åˆ†åªèƒ½å‘ç”Ÿåœ¨å…·ä½“æ¯ä¸ªShardä¸Šï¼Œå› ä¸ºæ¯ä¸ªShardéƒ½æ˜¯ä¸€ä¸ªå…¨å±€ç´¢å¼•ï¼Œè¿™æ˜¯å¼•æ“è®¾è®¡çš„ï¼Œé…åˆå»ºç´¢å¼•é˜¶æ®µShardæ–‡æ¡£é‡è´Ÿè½½å‡è¡¡æ‰€æœ‰æ–‡æ¡£æ—¶è¿™äº›å‚æ•°éƒ½ä¼šæ¥è¿‘ç›¸ç­‰ã€‚
æ‰€ä»¥ï¼Œæ–‡æ¡£é‡å°‘åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è§£å†³å‚æ•°å€¼ä¸ä¸€è‡´çš„é—®é¢˜ï¼š
ï¼ˆ1ï¼‰search_type=dfs_query_then_fetchï¼Œç›¸å½“äºè®¡ç®—æ—¶ä¼šå»è®¡ç®—æ‰€æœ‰Shardä¸Šçš„å‚æ•°å€¼ï¼Œå®æ—¶è®¡ç®—å–å€¼ï¼Œæ¯”è¾ƒæ…¢ï¼›
ï¼ˆ2ï¼‰preference=_primaryï¼Œåªåœ¨ä¸»åˆ†ç‰‡ä¸Šå€’æ’æ±‚äº¤ï¼Œæ²¡æœ‰åˆ©ç”¨å‰¯æœ¬åˆ†ç‰‡åšè®¡ç®—ï¼Œä¸ç®—æ…¢ã€‚
å»ºè®®ç”¨ç¬¬äºŒç§ã€‚

# 19ã€reindexå¼‚å¸¸ç»ˆæ­¢ï¼Œæ€ä¹ˆåœ¨æ–­ç‚¹ç»§ç»­æ‰§è¡Œï¼Ÿ
å›å¤ï¼š

ç”Ÿäº§ç¯å¢ƒè¿ç§»ï¼Œä½¿ç”¨reindexæ“ä½œè€æ•°æ®è¿ç§»ï¼ŒåŒæ—¶ç”Ÿäº§ä¹Ÿåœ¨å¾€ç´¢å¼•å†™æ•°æ®ï¼Œè€æ•°æ®è¿ç§»äº†å¥½å‡ å¤©ï¼Œç”±äºç½‘ç»œé—®é¢˜å¯¼è‡´reindexä¸­æ–­ï¼Œä¸æƒ³é‡æ–°reindexï¼Œè¯¥æ€ä¹ˆæ“ä½œï¼Ÿ
ä½¿ç”¨é»˜è®¤çš„è¿ç§»è„šæœ¬ï¼š
```
POST _reindex
{
"source": {
"remote": {
"host": "http://otherhost:9200&quot;,
"username": "user",
"password": "pass"
},
"index": "source",
"query": {
"match": {
"test": "data"
}
}
},
"dest": {
"index": "dest"
}
}
```
å›å¤ï¼š
Settings op_type to create will cause _reindex to only create missing documents in the target index. All existing documents will cause a version conflict:
```
POST _reindex
{
  "source": {
    "index": "twitter"
  },
  "dest": {
    "index": "new_twitter",
    "op_type": "create"
  }
}
```

# 20ã€å¤§å®¶å¥½è¯·é—®å¸¦æƒé‡çš„ç»¼åˆæœç´¢æ’ååº”è¯¥æ€ä¹ˆè®¾è®¡æ•°æ®å’Œå®ç°ï¼Ÿ

es çš„æ•™ç¨‹çœ‹äº†å¾ˆå¤šäº†ï¼Œä½†å¯¹äºæ•´ä½“çš„è®¾è®¡è¿˜æ˜¯ä¸€è„¸æ‡µXã€‚å¯èƒ½ç®€å•ç»™æˆ‘ä¸¾ä¾‹ä¸€ä¸‹å—ï¼Ÿ
ç°åœ¨çš„éœ€æ±‚å°±æ˜¯æ™®é€šçš„ç”µå•†ç³»ç»Ÿï¼Œè¦æƒ³æ ¹æ®é”€é‡ã€æˆäº¤é‡ã€è½¬æ¢ç‡ç­‰ç­‰åšä¸€ä¸ªâ€œç»¼åˆæ’åºâ€ã€‚é‚£æˆ‘æƒ³çŸ¥é“æ•°æ®ç»“æ„åº”è¯¥æ€ä¹ˆè¿›è¡Œè®¾è®¡ï¼Ÿå•†å“ä¿¡æ¯æœ‰ä¿®æ”¹ï¼Œåº”è¯¥ä½•æ—¶ç”¨ä»€ä¹ˆæ–¹å¼åŒæ­¥ es å‘¢ï¼Ÿæœ›å¤§å®¶è§£ç­”ï¼Œæ„Ÿæ¿€ä¸å°½ï¼ï¼ğŸ˜

å›å¤ï¼š
å‡ ç§æ€è·¯ä»…ä¾›å‚è€ƒ
1. åŸºç¡€æ•°æ®ä¹‹å¤–ï¼Œå†—ä½™å‡ ä¸ªå­—æ®µï¼Œæ¯”å¦‚é”€é‡ã€æˆäº¤é‡ã€è½¬æ¢ç‡ï¼Œç„¶åqueryçš„æ—¶å€™ç”¨scriptå¯¹è¿™å‡ ä¸ªå­—æ®µè¿›è¡ŒåŠ æƒè®¡ç®—ï¼Œæ¯”å¦‚ï¼š
return å¬å›å¾—åˆ† + é”€é‡ / 1000 +  æˆäº¤é‡ % 10 + è½¬æ¢ç‡ x 10
ç„¶åç³»ç»Ÿé‡Œèµ·å‡ ä¸ªç°æˆå¼‚æ­¥æ›´æ–°æ¯ä¸ªå•†å“çš„è¿™å‡ ä¸ªå­—æ®µ
 
2. æ¯ä¸ªå•†å“è¿™å‡ ä¸ªå­—æ®µå­˜ç¼“å­˜ï¼Œå¦‚redisï¼Œåœ¨æœç´¢å¬å›çš„æ—¶å€™ï¼Œé€šè¿‡è‡ªå®šçš„å…¬å¼ + äººå·¥è¿è¥ç­–ç•¥é‡æ–°æ’åº
 
 
 # 21ã€painless Numberæ•°æ®ç±»å‹æ— æ³•è½¬æ¢ä¸ºStringï¼Ÿ
 å›å¤ï¼š
 ```
 POST _scripts/painless/_execute
{
  "script": {
    "source": "Double.toString(Math.floor((params.a-params.b)/60))",
    "params": {
      "a": 70,
      "b": 10
    }
  }
}
```

# 22ã€count api å’Œ ç›´æ¥è®¾ç½®size = 0 ï¼Œ æ¥ç»Ÿè®¡æ¡æ•°çš„åŒºåˆ«ã€‚

é“­æ¯…æé†’â€”â€”7.Xè¦æ³¨æ„äº†ã€‚
å®˜æ–¹æä¾›äº†count api æ¥è·å–åŒ¹é…çš„ç»“æœï¼Œ å¦‚ä¸‹ï¼š
```
GET /twitter/tweet/_count
{
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```
é‚£ä¹ˆï¼ŒæŒ‰ç…§ä¸‹é¢è¿™ç§æ–¹æ³•ï¼Œå’Œcount æ–¹æ³•æœ‰ä½•åŒºåˆ«ï¼š
 ```
GET /twitter/tweet/_search
{
    "size": 0,
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```
ç»“æœéƒ½å¯ä»¥å¾—åˆ°ç›¸åº”çš„æ€»çš„åŒ¹é…çš„æ¡æ•°ã€‚ 

å›å¤ï¼š
å¦‚æœåªæ˜¯æ–‡æ¡£è®¡æ•°ï¼Œå»ºè®®ä½¿ç”¨count apiã€‚
Es 7.xç‰ˆæœ¬ï¼Œsearch apiä¸ºäº†æ€§èƒ½ï¼Œå·²ç»ä¸è¿”å›å‡†ç¡®çš„total hitï¼Œè€Œæ˜¯ä¸€ä¸ªä¼°ç®—å€¼ã€‚
 ```
search api
POST kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  }
}

//response
{
  "took" : 0,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,  //>10000
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [ ]
  }
}
```

https://elasticsearch.cn/question/8562
å›å¤ï¼šåœ¨æˆ‘çš„ç†è§£çœ‹æ¥ï¼Œcount å’Œ hit æ˜¯ä¸¤ç§ç±»å‹çš„æŸ¥è¯¢ï¼Œcountä»£è¡¨ç²¾ç¡®ç»Ÿè®¡ï¼ˆå’Œå…³ç³»å‹æ•°æ®åº“çš„countä¸€è‡´ï¼‰ï¼Œ
hitæ˜¯ä»ç›¸å…³æ€§çš„è§’åº¦æ¥ç»Ÿè®¡çš„ã€‚hitè¡¨ç¤ºï¼Œesæ£€ç´¢åˆ°äº†å’ŒæŸ¥è¯¢æ¡ä»¶ç›¸å…³çš„æ–‡æ¡£ï¼Œå¹¶æŒ‰ç…§ç›¸å…³æ€§æ’åºï¼Œè¿”å›topNï¼Œè‡³äºåˆ°åº•æœ‰å¤šå°‘æ–‡æ¡£å’ŒæŸ¥è¯¢æ¡ä»¶ç›¸å…³ï¼Œ
å…¶å®æ˜¯ä¸é‡è¦çš„ã€‚å¦‚æœä½ ç¡®å®æƒ³çŸ¥é“ï¼Œtrack-toal-hitså°±æ´¾ä¸Šäº†ç”¨åœºï¼Œå½“è®¾ç½®ä¸ºtrueæ—¶ï¼Œå®ƒä¼šç²¾ç¡®ç»Ÿè®¡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªé˜ˆå€¼ï¼Œå®ƒä¼šå‘Šè¯‰ä½ å®é™…å€¼æ˜¯å¦æ¯”é˜ˆå€¼å¤§ã€‚

è¯•è¯•å°†track_total_hitsè®¾ç½®ä¸ºtrueï¼Œè€Œä¸æ˜¯ä¸€ä¸ªé˜ˆå€¼ã€‚
When set to true the search response will always track the number of hits that match the query accurately.


æ¨èåšæ–‡ç³»åˆ—ï¼š

1ã€https://www.cnblogs.com/hapjin/p/11254535.html

2ã€https://blog.csdn.net/UbuntuTouch/article/details/102642703

3ã€https://elasticsearch.cn/article/13533




 
