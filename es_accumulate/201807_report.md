# é—®é¢˜1ï¼šROOTç”¨æˆ·å¯åŠ¨ESåå‡ºç°Too many open fileså¼‚å¸¸
https://elasticsearch.cn/question/4702

1ï¼‰åœ¨ä¸€ä¸ªå•æœºç¯å¢ƒé€šè¿‡rootç”¨æˆ·å¯åŠ¨ESï¼Œå…±æœ‰690ä¸ªåˆ†ç‰‡ï¼Œå´å‡ºç°Too many open fileså¼‚å¸¸ï¼Œéƒ¨åˆ†åˆ†ç‰‡æ— æ³•å¯åŠ¨ï¼Œç³»ç»Ÿçš„å¥æŸ„æ•°é…ç½®ä¸º65534ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å¤Ÿäº†ï¼Œå´ä¸çŸ¥ä¸ºä½•å‡ºç°è¿™ç§å¼‚å¸¸ï¼Œå¯èƒ½è·Ÿå¯åŠ¨ç”¨æˆ·æœ‰å…³ã€‚

å›å¤ï¼šè¿™ä¸ªåŸå› æœ‰å¾ˆå¤šï¼Œé¦–å…ˆä½ è¦ç¡®è®¤çš„æ˜¯ Elasticsearch å…·ä½“çš„å¯ç”¨å¥æŸ„æ•°åˆ°åº•æ˜¯å¤šå°‘ï¼ŒElasticsearch æœ‰ API å¯ä»¥çœ‹çš„ã€‚

http://localhost:9200/_nodes/stats?prettyï¼š

åœ¨ process èŠ‚ç‚¹ä¸‹é¢æ‰¾åˆ°ï¼š


```
"process" : {
"timestamp" : 1530755737626,
"open_file_descriptors" : 620,
"max_file_descriptors" : 10240,
```

å¯ä»¥çœ‹åˆ°å½“å‰æ‰“å¼€çš„å’Œæœ€å¤§çš„è®¾ç½®ã€‚

2ï¼‰ä¸€èˆ¬æ¥è¯´ä¸€å°æœºå™¨ä¸Š65534ä¸ªæ–‡ä»¶å¥æŸ„å¯¹äºESæ¥è¯´è¶³å¤Ÿç”¨äº†ï¼Œé™¤éå¾ˆå¤¸å¼ äº†çš„åœ¨å•æœºä¸Šå­˜å‚¨äº†å¤§é‡çš„å°ç´¢å¼•ã€‚   å¦å¤–è¦ç¡®è®¤ESçš„å¯åŠ¨ç”¨æˆ·ï¼Œä»¥åŠæ”¹ç”¨æˆ·çš„æ–‡ä»¶å¥æŸ„ä¹¦è®¾ç½®çš„ç¡®æ­£ç¡®å¹¶ç”Ÿæ•ˆäº†ã€‚ åˆ‡æ¢åˆ°å¯¹åº”çš„ç”¨æˆ·ä¸‹ï¼Œç”¨ulimit -n å¤æ ¸ä¸€ä¸‹ã€‚

# 2ã€ã€å­˜å‚¨ç›¸å…³ã€‘å“ªç§ç±»å‹çš„æ•°æ®ä¼šå ç”¨å¤§é‡terms_memoryï¼Œæœ‰ä½•ä¼˜åŒ–æ–¹æ¡ˆï¼Ÿ
https://elasticsearch.cn/question/4714

1ï¼‰é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªç´¢å¼•æ¯å¤©äº§ç”Ÿ2+TBçš„æ•°æ®ï¼Œå¤§çº¦å ç”¨æ‰10Gçš„å†…å­˜ï¼Œå…¶ä¸­terms_memoryå äº†9G+ã€‚mappingä¸­æ‰€æœ‰stringç±»å‹çš„å­—æ®µä½¿ç”¨keywordç±»å‹ï¼Œæœ‰ä¸€ä¸ªmsgå­—æ®µè¾ƒé•¿ï¼Œå°†è¯¥å­—æ®µçš„indexè®¾ä¸ºfalseä¹‹åï¼Œå†…å­˜é™åˆ°6G+ä½†ä»ç„¶è¾ƒé«˜ã€‚

æˆ‘è®¤ä¸ºçš„terms_memoryæ˜¯ä½¿ç”¨å€’æ’ç´¢å¼•å ç”¨çš„å†…å­˜ï¼Œå€’æ’æ˜¯åœ¨åˆ†è¯ä¹‹åäº§ç”Ÿçš„ï¼Œkeywordç±»å‹çš„ä¸éœ€è¦åˆ†è¯ä¸ºä»€ä¹ˆä¹Ÿä¼šå ç”¨terms_memoryï¼Ÿæ˜¯ä¸æ˜¯å› ä¸ºkeywordå­—æ®µä¸­ï¼Œæ•´ä¸ªå­—æ®µä¸­çš„å†…å®¹å°±æ˜¯ä¸€ä¸ªtermï¼Ÿ
åœ¨å…³é—­indexä¹‹åè¿˜å‰©ä¸‹6G+çš„terms_memoryæ˜¯å“ªäº›åŠŸèƒ½å ç”¨çš„ï¼Ÿ

2ï¼‰æ®æˆ‘æ‰€çŸ¥ï¼Œç›®å‰æ²¡æœ‰apiå¯ä»¥æŸ¥çœ‹å•ä¸ªå­—æ®µçš„term memoryã€‚

3ï¼‰keyword ä¸æ˜¯ä¸åˆ†è¯ï¼Œæ˜¯æŠŠæ•´ä¸ªå†…å®¹ä½œä¸ºä¸€ä¸ª term å¤„ç†ï¼Œindex è®¾ä¸º false æ˜¯ä¸åˆ†è¯ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸èƒ½é’ˆå¯¹è¯¥å­—æ®µä½œæœç´¢ã€‚
 
å¦‚æœä»…è¿‡æ»¤å’Œèšåˆåˆ†æè¿˜å¯ä»¥æŠŠ norms è®¾ä¸º falseï¼Œå¦‚æœä¸åšèšåˆåˆ†æå’Œæ’åºï¼Œé‚£ä¹ˆå—¨å¯ä»¥æŠŠ doc_value è®¾ä¸º false
 
 
è¿˜æœ‰ä¸€ä¸ªè®¾ç½®æ˜¯ enabled è®¾ç½®ä¸º false çš„è¯ï¼Œå°±åªåšå­˜å‚¨ï¼Œå…¶ä»–å•¥éƒ½åšä¸äº†äº†

# 3ã€ESçš„å†™æ“ä½œç–‘é—®
ç‰ˆæœ¬ï¼šES6.x
çœ‹äº†ç½‘ä¸Šçš„å¾ˆå¤šè¯´ESæ’å…¥æ“ä½œçš„æµç¨‹ï¼Œæœ‰å¦‚ä¸‹ç–‘é—®ï¼š
 
å½“è¯·æ±‚è¦åˆ›å»ºDocçš„æ—¶å€™ï¼Œä¸»åˆ†ç‰‡æ¥å—è¯·æ±‚å¹¶è½¬å‘è¯·æ±‚åˆ°å‰¯æœ¬æ‰€åœ¨çš„èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæ˜¯ä¸»åˆ†ç‰‡å†™æˆåŠŸå°±è¿”å›ç»™å®¢æˆ·ç«¯æˆåŠŸäº†è¿˜æ˜¯è¦ç­‰æ‰€æœ‰çš„å‰¯æœ¬åˆ†ç‰‡éƒ½æˆåŠŸäº†æ‰è¿”å›ç»™å®¢æˆ·ç«¯æˆåŠŸï¼Œå¦‚æœæ˜¯ç¬¬äºŒä¸ªçš„è¯ é‚£ä¹ˆæœ‰çš„å‰¯æœ¬åˆ†ç‰‡æ‰€åœ¨çš„èŠ‚ç‚¹å†™å¤±è´¥äº†æˆ–è€…è¶…æ—¶äº† è¿™ä¸ªæ—¶å€™æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œæœ‰ç‚¹ç–‘é—®ï¼Œè¯·çŸ¥é“çš„åŒå­¦è¯´ä¸‹è¿™ä¸ªæµç¨‹ã€‚è°¢è°¢

https://elasticsearch.cn/question/4764

1ï¼‰å½“å‰ç‰ˆæœ¬(ES6.0)é‡Œï¼Œæ¯ä¸ªshardéƒ½ä¼šåœ¨masterç»“ç‚¹é‡Œç»´æŠ¤ä¸€ä¸ªin-sync groupã€‚ æ¯æ¬¡å†™æ“ä½œï¼Œéƒ½æ˜¯å…ˆå‘ç»™å¯¹åº”in-sync groupé‡Œçš„ä¸»ç‰‡ï¼Œä¸»ç‰‡å†™æˆåŠŸä»¥åï¼Œå†å¹¶å‘è½¬å‘ç»™groupå†…å…¶ä»–çš„å‰¯ç‰‡ã€‚ åªæœ‰å…¨éƒ¨ä¸»å’Œå‰¯éƒ½å†™æˆåŠŸäº†ï¼Œæ‰ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ã€‚
 
å¦‚æœä¸»ç‰‡å†™æˆåŠŸäº†ï¼Œä½†æŸä¸ªå‰¯ç‰‡æ‰€åœ¨ç»“ç‚¹æ•…éšœï¼Œæ— æ³•å“åº”æˆ–è€…å“åº”è¶…æ—¶ï¼Œ ä¸»åˆ†ç‰‡ä¼šå‘masterå‘é€shard failedé€šçŸ¥ï¼Œç”±masteræ›´æ–°in-sync groupï¼Œå°†å¤±è´¥çš„å‰¯ç‰‡ä»ç»„å†…å‰”é™¤å‡ºå»ã€‚ ä¹‹åï¼Œåªè¦æ˜¯å‰©ä½™çš„in-sync shardéƒ½å†™æˆåŠŸäº†ï¼Œå°±ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ é»˜è®¤çš„é›†ç¾¤é…ç½®æƒ…å†µä¸‹ï¼Œåªè¦in-sync groupé‡Œæœ‰è‡³å°‘ä¸€ä¸ªshardå¯ç”¨(ç”¨æ¥æ‹…å½“ä¸»ç‰‡è§’è‰²)ï¼Œå†™å…¥å°±å¯ä»¥æˆåŠŸï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

2ï¼‰esåœ¨æ–°å»ºæ›´æ–°åˆ é™¤çš„æ—¶å€™éƒ½ä¼šéµå¾ªä¸¤ä¸ªåŸåˆ™ consistency å’Œ timeout å…·ä½“çœ‹ä¸‹æ–‡æ¡£å§ 
https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-write.html

# 4ã€ES å®˜æ–¹æ–‡æ¡£è¯´å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šèŠ‚ç‚¹çš„ç±»å‹ã€‚ä½†æ˜¯æ²¡æœ‰å†™æ€ä¹ˆåœ¨é…ç½®æ–‡ä»¶ä¸­å†™å•Šï¼Ÿæ±‚æŒ‡æ•™

-Enode.attr.size=bigè¿™ä¸ªå€¼ï¼Ÿåœ¨é…ç½®æ–‡ä»¶ä¸­æ€ä¹ˆå†™å…·ä½“ã€‚

åœ¨elasticsearch.yamlé‡Œç”¨å¦‚ä¸‹æ ¼å¼å†™å°±å¯ä»¥äº†
node.attr.boxtype: strong
node.attr.group: 10
å±æ€§å¯ä»¥æœ‰å¤šä¸ªã€‚

# 5ã€ä¸€ä¸ªç´¢å¼•æœ‰5äº¿çš„æ•°æ®é‡ï¼Œä¸”è¿™ä¸ªç´¢å¼•æœ‰æ›´æ–°æ“ä½œï¼Œè¯·é—®å¤šå°‘shardsåˆé€‚å‘¢ï¼Ÿ
https://elasticsearch.cn/article/32

dataèŠ‚ç‚¹æœ‰50å°ï¼ˆ16C/32Gï¼‰ï¼Œ25shards+25replicaè¿™æ ·åˆç†å—ï¼Ÿ

kennywu76 å›å¤ Todo
1ï¼‰
å¦‚æœå•æ¬¡æœç´¢çš„æ—¶å»¶å¯ä»¥æ»¡è¶³ä¸šåŠ¡ä¸Šçš„è¦æ±‚ï¼Œå¯ä»¥è¿™ä¹ˆåˆ’åˆ†ã€‚ å¦‚æœæ—¶å»¶è¿‡é«˜ï¼Œå¯ä»¥å¢åŠ shardæ•°é‡ï¼Œä»£ä»·æ˜¯æ¯æ¬¡æœç´¢çš„å¹¶å‘é‡å¢å¤§ï¼Œå¸¦æ¥çš„é¢å¤–å¼€é”€æ›´å¤§ï¼Œå› è€Œé›†ç¾¤èƒ½æ”¯æ’‘çš„å³°å€¼QPSå¯èƒ½ä¼šé™ä½ã€‚ åŸåˆ™ä¸Šï¼Œåœ¨æ»¡è¶³æœç´¢æ—¶å»¶çš„å‰æä¸‹ï¼Œåˆ’åˆ†å°½é‡å°‘çš„shardã€‚ 

å¦å¤–æœ‰ä¸€ç§åœºæ™¯åˆ’åˆ†æ›´å¤šçš„shardæ˜¯åˆç†çš„ï¼Œé‚£å°±æ˜¯é›†ç¾¤å¤§å¤šæ•°æœç´¢éƒ½ä¼šç”¨åˆ°æŸä¸ªå­—æ®µåšè¿‡æ»¤ï¼Œæ¯”å¦‚åŸå¸‚idã€‚ è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥ç”¨è¯¥å­—æ®µåšä¸ºrouting_keyï¼Œå°†ç›¸å…³è”çš„æ•°æ®routeåˆ°æŸä¸ªæˆ–æŸå‡ ä¸ª(å¦‚æœç”¨åˆ°routing partition)shardã€‚ é€‚å½“å¤šåˆ’åˆ†ä¸€äº›shardï¼Œå¯ä»¥è®©å•ä¸ªshardä¸Šçš„æ•°æ®é›†è¾ƒå°ï¼Œæœç´ é€Ÿåº¦å¿«ï¼ŒåŒæ—¶å› ä¸ºæœç´¢ä¸ä¼šhitæ‰€æœ‰çš„shardï¼Œè§„é¿äº†åˆ’åˆ†è¿‡å¤šçš„shardå¸¦æ¥çš„å¹¶å‘è¿‡é«˜ï¼Œä»¥åŠéœ€è¦æ±‡æ€»çš„æ•°æ®è¿‡å¤šå¼•èµ·çš„æ€§èƒ½é—®é¢˜ã€‚

# 6ã€ã€ç¼“å­˜é—®é¢˜ã€‘å¦‚æœç´¢å¼•é¢‘ç¹æ›´æ–°ï¼Œç¼“å­˜ä¼šæ€ä¹ˆåŠ
å¦‚æœç´¢å¼•é¢‘ç¹æ›´æ–°ï¼Œç¼“å­˜ä¼šæ€ä¹ˆåŠï¼Ÿç¼“å­˜ä¸å°±ä¼šå¯¼è‡´æœç´¢ç»“æœä¸å¯¹äº†å—

https://elasticsearch.cn/question/4908

å›å¤ï¼šæˆ‘å…ˆå‡å®šä½ è°ˆè®ºçš„æ˜¯Query Cacheï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥cacheæ— éœ€æ‰“åˆ†çš„filterçš„ç»“æœé›†çš„ã€‚ é‚£ä¹ˆè¿™ä¸ªcacheæ˜¯æ™ºèƒ½ä¸”å‡†å®æ—¶çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ä¸€æ—¦cacheç¬¬ä¸€æ¬¡å»ºç«‹ä»¥åï¼Œç´¢å¼•æ–°å¢çš„æ•°æ®ï¼Œåœ¨æœç´¢çš„æ—¶å€™ï¼Œä¼šè¢«å¢é‡çš„åŠ å…¥åˆ°cacheé‡Œã€‚  æ›´ç»†èŠ‚åœ°ç‚¹è®²ï¼Œè¿™ä¸ªcacheç²’åº¦æ˜¯åœ¨segmentçº§åˆ«çš„ï¼Œå¢é‡cacheæ„å»ºï¼Œå°±æ˜¯é’ˆå¯¹æ–°å¢çš„segmentï¼Œä»¥åŠå‘ç”Ÿè¿‡mergeçš„segmentã€‚

# 7ã€"cluster.routing.allocation.disk.watermark.low"å‚æ•°ä¸ºä»€ä¹ˆä¸èƒ½ç¦æ­¢å‘èŠ‚ç‚¹åˆ†ç‰‡åˆ†ç‰‡ï¼Ÿ
"cluster.routing.allocation.disk.watermark.low"è¿™ä¸ªå‚æ•°æ˜¯å½“æŸä¸ªèŠ‚ç‚¹çš„ç£ç›˜ä½¿ç”¨é‡è¾¾åˆ°è®¾ç½®å€¼åï¼Œé›†ç¾¤å°†ä¸å†å‘æ­¤èŠ‚ç‚¹åˆ†é…å‰¯æœ¬åˆ†ç‰‡ï¼Œæ³¨æ„ï¼Œä¸å†åˆ†é…å‰¯æœ¬åˆ†ç‰‡ã€‚æ‰€ä»¥è¿™ä¸ªé…ç½®é¡¹å¯¹äºä¸»åˆ†ç‰‡æ˜¯é€æ˜çš„ã€‚
æ‰€ä»¥å¦‚æœé›†ç¾¤ä¸­æœ‰çš„æ•°æ®èŠ‚ç‚¹å¿«è¢«å†™æ»¡äº†ï¼Œè¿™ä¸ªå€¼æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨çš„ã€‚ã€
æˆ‘çš„é—®é¢˜æ˜¯ï¼šESä¸ºä»€ä¹ˆåªèƒ½é™åˆ¶å‰¯æœ¬åˆ†ç‰‡çš„åˆ†é…ï¼Ÿå¦‚æœèŠ‚ç‚¹è¢«å†™æ»¡ï¼ŒèŠ‚ç‚¹ä¼šå‡ºç°æ•…éšœï¼Œé›†ç¾¤ä¹Ÿä¼šå‡ºç°æ•…éšœï¼Œä¸ºä»€ä¹ˆä¸èƒ½è®¾ç½®"cluster.routing.allocation.disk.watermark.low"è¿™ä¸ªå‚æ•°ç¦æ­¢æ‰€æœ‰æ–°åˆ†é…çš„åˆ†ç‰‡ï¼Ÿ
 
æˆ‘çš„æƒ³æ³•æ˜¯ï¼šESé‡å¹³è¡¡æ˜¯æŒ‰ç…§èŠ‚ç‚¹åˆ†ç‰‡æ•°æ¥é‡å¹³è¡¡çš„ï¼Œå¦‚æœ"cluster.routing.allocation.disk.watermark.low"è¿™ä¸ªå€¼å¯ä»¥ç¦æ­¢æ‰€æœ‰åˆ†ç‰‡çš„åˆ†é…ï¼Œå°†åŠ¿å¿…é€ æˆé›†ç¾¤èŠ‚ç‚¹é—´åˆ†ç‰‡æ•°çš„ä¸å¹³ç­‰ï¼Œä»è€Œé€ æˆæŒç»­çš„â€œé‡å¹³è¡¡â€ï¼Œè€Œæœ‰äº›èŠ‚ç‚¹åˆç¦æ­¢åˆ†é…åˆ†ç‰‡ï¼Œè¿™æ ·çš„è¯ï¼Œé›†ç¾¤å°†å¤„äºä¸æ–­å¯åŠ¨é‡å¹³è¡¡çš„æ­»å¾ªç¯ï¼Ÿ

https://elasticsearch.cn/question/4911

å›å¤:
low watermarkä¸æ˜¯å¯¹ä¸»åˆ†ç‰‡é€æ˜ï¼Œå¦‚æœä½ ä»”ç»†é˜…è¯»ä¸€ä¸‹æ–‡æ¡£ï¼Œè¿™ä¸ªå‚æ•°æ˜¯å¯¹â€œæœªåˆ†é…è¿‡çš„"ä¸»åˆ†ç‰‡æ— æ•ˆï¼Œå³æ–°åˆ›å»ºçš„ç´¢å¼•çš„åœºæ™¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªç»“ç‚¹çš„ç£ç›˜ç©ºé—´æ¶ˆè€—è¾¾åˆ°low watermarkä»¥åï¼Œæ–°åˆ›å»ºçš„ç´¢å¼•ä¸å—é™åˆ¶ï¼Œä¾ç„¶å¯ä»¥åˆ†é…åˆ°ä¸Šé¢ã€‚ ä¸èƒ½å¤Ÿåˆ†é…ä¸Šå»çš„åœºæ™¯ä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ä¸ª:
é›†ç¾¤æœ‰ç»“ç‚¹æŒ‚æ‰æˆ–è€…ç”¨æˆ·æ›´æ”¹äº†é›†ç¾¤çš„å¤åˆ¶ç‰‡æ•°é‡ï¼Œ éœ€è¦æŒ‘é€‰æŸä¸ªç»“ç‚¹å¤åˆ¶åˆ†ç‰‡çš„æ—¶å€™
é›†ç¾¤è§¦å‘äº†rebalanceçš„æ—¶å€™
 
è¿™ä¹ˆè®¾è®¡ä¹Ÿæ˜¯æœ‰é“ç†çš„ï¼Œlow watermarkè¡¨è¾¾çš„å«ä¹‰æ˜¯ç£ç›˜ç©ºé—´è¾ƒä½ï¼Œä¸ºäº†ä¿æŠ¤å·²æœ‰æ•°æ®çš„è¿›ä¸€æ­¥ç©ºé—´æ¶ˆè€—ï¼ˆæ•°æ®çš„æŒç»­å†™å…¥ï¼Œ mergeçš„ä¸´æ—¶ç©ºé—´æ¶ˆè€—)ï¼Œç¦æ­¢æœ‰æ•°æ®çš„shardå‘ä¸Šé¢åˆ†é…ã€‚ è€Œæ–°åˆ›å»ºçš„ç´¢å¼•ï¼Œä¸€å¼€å§‹æ˜¯ç©ºçš„ï¼Œåˆ†é…ä¸Šå»ä¹Ÿæ— æ‰€è°“ã€‚
 
low watermarkæ˜¯ä¸ç®¡ç£ç›˜æ•°æ®ç»“ç‚¹æ˜¯å¦å¿«å†™æ»¡äº†çš„ï¼Œæœ‰å¦å¤–ä¸€ä¸ªå‚æ•°"cluster.routing.allocation.disk.watermark.high"æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚è¿™ä¸ªé˜ˆå€¼è§¦å‘ä»¥åï¼ŒESä¼šå°†è¯¥ç»“ç‚¹ä¸Šçš„æ•°æ®å¼€å§‹å¾€å…¶ä»–ç»“ç‚¹è¿ç§»ï¼Œè¯¥å‚æ•°å¯¹æ‰€æœ‰shardæœ‰æ•ˆã€‚
 
ä¸¤ä¸ªwatermarkåˆç†é…ç½®ï¼Œå¯ä»¥å‡å°‘æ•°æ®è¿ç§»çš„é¢‘ç‡ï¼ŒåŒæ—¶ä¿éšœç»“ç‚¹ç£ç›˜ç©ºé—´ä¸ä¼šè¿‡ä½ã€‚
 
æœ€åè¿˜æœ‰ä¸€é“é˜²çº¿"cluster.routing.allocation.disk.watermark.flood_stage" ï¼Œä¸‡ä¸€åº”ç”¨å†™æ•°æ®å¤ªçŒ›ï¼Œè¶…è¿‡é¢„æœŸï¼Œç£ç›˜ç©ºé—´é™å¤ªå¿«ï¼Œæ¥ä¸åŠå¾€å¤–è¿ç§»ï¼Œè¿™ä¸ªé˜ˆå€¼è§¦å¯èƒ½è¢«è§¦å‘ã€‚ è§¦å‘æ—¶ï¼ŒESä¼šå°†ç»“ç‚¹ä¸Šçš„ç´¢å¼•è®¾ç½®ä¸ºåªè¯», é¿å…ç£ç›˜ç©ºé—´çˆ†æ‰ï¼Œå½±å“ç»“ç‚¹çš„å¯ç”¨æ€§ã€‚

# 8ã€ESä¸­threadpoolçš„directç±»å‹
åœ¨é˜…è¯»ES2.1æºç çš„è¿‡ç¨‹ä¸­å‘ç°thread poolçš„ç±»å‹æœ‰å››ç§
cached,fixed,scalingè¿™ä¸‰ç§ç±»å‹åœ¨å®˜ç½‘ä¸Šéƒ½èƒ½æŸ¥åˆ°ï¼Œdirectæ˜¯ä»€ä¹ˆç±»å‹å‘¢ï¼Ÿ

https://elasticsearch.cn/question/4927

å›å¤1ï¼šå‚è€ƒ
https://www.felayman.com/articles/2017/11/10/1510291570687.html

1ï¼‰direct
æ­¤ç±»çº¿ç¨‹æ˜¯ä¸€ç§ä¸æ”¯æŒå…³é—­çš„çº¿ç¨‹,å°±æ„å‘³ç€ä¸€æ—¦ä½¿ç”¨,åˆ™ä¼šä¸€ç›´å­˜æ´»ä¸‹å».

2ï¼‰fixed
æ­¤ç±»çº¿ç¨‹æ± æ‹¥æœ‰å›ºå®šæ•°é‡çš„çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼Œåœ¨æ²¡æœ‰ç©ºé—²çº¿ç¨‹æ—¶è¯·æ±‚å°†è¢«æŒ‚åœ¨é˜Ÿåˆ—ä¸­ï¼ˆå¯é€‰é…ï¼‰

3ï¼‰scaling
æ­¤ç±»çº¿ç¨‹æ± æ‹¥æœ‰çš„çº¿ç¨‹æ•°é‡æ˜¯åŠ¨æ€çš„ã€‚è¿™ä¸ªæ•°å­—ä»‹äºcoreå’Œmaxå‚æ•°çš„é…ç½®ä¹‹é—´å˜åŒ–

å›å¤2ï¼šDirectç±»å‹è¡¨ç¤ºç”¨å½“å‰çº¿ç¨‹æ‰§è¡Œæäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è¯¥çº¿ç¨‹ä¸èƒ½è¢«å…³é—­ã€‚æˆ‘çš„ç†è§£æ˜¯æ¯”è¾ƒè½»é‡çº§æˆ–è€…éœ€è¦å•çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡æäº¤ç»™è¿™ä¸ªexecutorã€‚


# 9ã€ElasticsearchæŸ¥è¯¢æ—¶æŒ‡å®šåˆ†è¯å™¨
é—®é¢˜æè¿°:
    ESç›®å‰ä½¿ç”¨çš„æ˜¯IKåˆ†è¯å™¨,æŸ¥è¯¢æ—¶çš„åˆ†è¯ä¹Ÿæ˜¯IK,ä½†ç°åœ¨æƒ³æŸ¥è¯¢èµ°çš„åˆ†è¯è¿˜æ˜¯ESçš„ Standard Analyzer
	 es_result = get_es_connect().search(
            index=index,
            doc_type=_type,
            body=dsl,
            timeout=timeout
        )
	ä½¿ç”¨pythonè¯­è¨€ç¼–ç ï¼Œ è¿™ä¸ªsearchæœ‰ä¸ªanalyzerå‚æ•°,æŒ‡å®šä¸ºstandardæŠ¥é”™.
è¯·é—®è¿™ä¸ªé—®é¢˜æ˜¯åœ¨mappingä¸­æŒ‡å®šå‘¢,è¿˜æ˜¯å¯ä»¥åœ¨æ–¹æ³•ä¸­æŒ‡å®šï¼Œè¯·æŒ‡ç‚¹ä¸€äºŒï¼Ÿ

https://elasticsearch.cn/question/4979

æœ‰ä¸‰ç§æ–¹å¼å¯ä»¥æŒ‡å®šæŸ¥è¯¢åˆ†æå™¨:
1ï¼‰. åœ¨mappingé‡ŒæŒ‡å®šsearch_analyzerï¼Œä¾‹å¦‚
PUT my_index
{
  "mappings": {
    "doc": {
      "properties": {
        "uid": {
          "type": "keyword"
        },
        "name": {
          "type": "text",
          "analyzer": "english",
          "search_analyzer": "standard"
        }
      }
    }
  }
}
 
2ï¼‰.ä½¿ç”¨URL Searchçš„æ—¶å€™ï¼ŒæŒ‡å®šanalyzerå‚æ•° ï¼Œæ–‡æ¡£å‚è€ƒ: https://www.elastic.co/guide/e ... .html , å¯¹åº”çš„pythonä»£ç èŒƒä¾‹: 
>>> es.search(index="my_index", analyzer="standard", q='name:"mark AND johnson"')
è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„analyzeråªèƒ½å’Œqè¿™ä¸ªå‚æ•°æ­é…ä½¿ç”¨ã€‚ ä½ çš„ä»£ç æŠ¥é”™ï¼Œæ˜¯å› ä¸ºç”¨çš„bodyå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æ²¡æœ‰analyzerå‚æ•°æ­é…çš„ã€‚

3ï¼‰ä½¿ç”¨Request Body Searchï¼Œæ–‡æ¡£å‚è€ƒ: https://www.elastic.co/guide/e ... .html  ,å¯¹åº”çš„pythonä»£ç èŒƒä¾‹:
>>> dsl='{"query": {"match": {"name": {"query": "mark","analyzer": "standard"}}}}'
>>> es.search(index="my_index", body=dsl)
æ³¨æ„è¿™ä¸ªæ—¶å€™ï¼Œanalyzeræ˜¯å†™åˆ°dslé‡Œé¢çš„match queryã€‚

# 10ã€ã€å¤æ‚èšåˆï¼Œç©ºé—´æ¢æ—¶é—´ã€‘elasticsearchå¤šé‡èšåˆã€æ’åºã€æ€§èƒ½ï¼Ÿ
æºè‡ªå…¬å¸ åº—é“ºæœç´¢çš„éœ€æ±‚
1ã€æ£€ç´¢å­—æ®µä¸º åº—é“ºå+å•†å“å
2ã€åº—é“ºä¸‹å­˜åœ¨å•†å“ï¼Œå•†å“å­˜åœ¨ä¸»å­å•†å“ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸¤å±‚èšåˆ
3ã€å¦‚æœåªå‘½ä¸­å•†å“åï¼Œå¹¶ä¸”å‘½ä¸­å•†å“åä¸ªæ•°å°äº4ï¼Œåˆ™è¯¥åº—é“ºä¸è¿”å›
4ã€éœ€è¦æ”¯æŒåº—é“ºå†…å•†å“çš„é”€é‡æ’åºï¼Œå¦‚æœå•†å“åå‘½ä¸­äº†åˆ™æƒé‡å¤§äºé”€é‡æƒé‡
5ã€æ”¯æŒåº—é“ºå±‚é¢çš„åˆ†é¡µè·å–

æœ¬äººè¯•äº†çˆ¶å­æ–‡æ¡£ï¼Œéœ€è¦å»ºç«‹ä¸¤å±‚å­æ–‡æ¡£ï¼Œä½¿ç”¨hasparentæŸ¥è¯¢å›åº—é“ºæ•ˆç‡è¿˜å¥½ï¼Œä½†æ˜¯ä½¿ç”¨haschildæŸ¥è¯¢æ—¶ï¼Œéœ€è¦æŸ¥è¯¢ä¸¤å±‚ï¼Œæ€§èƒ½å¤§å¤§é™ä½äº†ï¼Œå¤§ç¥ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½çš„è§£å†³åŠæ³•

https://elasticsearch.cn/question/4680

medclå›å¤ï¼šè¿½æ±‚æ€§èƒ½çš„è¯ï¼Œèƒ½ä¸ç”¨çˆ¶å­æŸ¥è¯¢å°±åˆ«ç”¨ï¼Œéƒ½åœ¨ä¸€ä¸ªç´¢å¼•æ–‡æ¡£é‡Œé¢ï¼Œå†—ä½™ä¸€ç‚¹å…¶å®ä¹Ÿæ²¡å•¥ã€‚

# 11ã€ã€5.3å·²ç»ç§»é™¤ã€‘query and fetch åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”¨åˆ°å‘¢
query and fetchå’Œthençš„åŒºåˆ«æ˜¯å‰è€…åªéœ€è¦å»æ¯ä¸ªåˆ†ç‰‡å»ä¸€æ¬¡sizeå¤§å°çš„æ•°æ®ï¼Œåè€…æ˜¯å…ˆfetchæ–‡æ¡£å¾—åˆ†idç­‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œç„¶åå†å–topNã€‚
 
è¿™æ ·çœ‹æ¥ï¼Œå‰è€…è™½ç„¶åªæœ‰ä¸€æ¬¡rpcï¼Œä½†æ˜¯ä¸€æ¬¡æŸ¥è¯¢åå†coordinateä¸­å ç”¨å†…å­˜å¾ˆå¤šï¼Œåˆ†ç‰‡è¶Šå¤§ï¼Œsizeå¢å¤šä¼šæœ‰éšæ‚£ã€‚è€Œåè€…è™½ç„¶è¦èµ°ä¸¤æ¬¡rpcï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡è·å–å…ƒæ•°æ®ä¿¡æ¯å†…å­˜å ç”¨å¾ˆå°‘ï¼Œç¬¬äºŒæ¬¡åªéœ€è¦è·å–sizeå¤§å°æ•°æ®å³å¯ï¼Œæ„Ÿè§‰è¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚
 
è€Œä¸”å‰è€…è¿”å›çš„æ˜¯sizeçš„Nå€ï¼ˆNæ˜¯åˆ†ç‰‡æ•°ï¼‰ï¼Œä¸šåŠ¡ä¸Šé€šå¸¸éƒ½æ˜¯å»å¤šå°‘ç”¨å¤šå°‘çš„ï¼Œæˆ‘è®¾ç½®size=10ä½ ç»™æˆ‘30æˆ‘ä¼šè®¤ä¸ºæŸ¥è¯¢è¯­å¥æœ‰é”™è¯¯ï¼Œä¸å¸Œæœ›è¦å¤šä½™çš„æ•°æ®ã€‚åè€…è‡³å°‘èƒ½ä¿è¯æˆ‘å–å¤šå°‘å°±è¦å¤šå°‘ã€‚
 
æ‰€ä»¥ä¸æ˜ç™½å‰è€…ä¸ºä»€ä¹ˆä¸åœ¨è¿”å›ä¹‹å‰åšä¸€æ¬¡topNã€‚
 é‚£ä¹ˆquery and fetch åœ¨ä»€ä¹ˆåœºæ™¯ ä¸‹ä¼šç”¨åˆ° å‘¢ï¼Ÿ
https://elasticsearch.cn/question/4740

medcl å›å¤ï¼š
query_and_fetch ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œå†…éƒ¨ä¼˜åŒ–çš„ï¼Œå¦‚æœä½ åªæœ‰ä¸€ä¸ªåˆ†ç‰‡ï¼Œä½ å®Œå…¨ä¸éœ€è¦åˆ†ä¸¤ä¸ªé˜¶æ®µï¼ˆè®°ä½ï¼Œä½ åªæœ‰ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¸ç”¨ç®¡å…¶ä»–åˆ†ç‰‡çš„æƒ…å†µï¼‰ï¼Œå…ˆæ‹¿ä¸€æ¬¡åˆ†ç‰‡ä¸‹çš„å¾—åˆ†ä¿¡æ¯å†æ‹¿å…·ä½“çš„æ–‡æ¡£ï¼Œä¸å¦‚ä¸€æ¬¡æ€§æ‹¿å›æ¥å°±å¥½äº†ã€‚
 
æ‰€ä»¥ query_and_fetch ä»æ¥ä¸æ˜¯ç›´æ¥ç»™ç”¨æˆ·æ¥ä½¿ç”¨çš„ï¼Œå¹¶ä¸”åœ¨ 5.3 ç‰ˆæœ¬ä¹‹åå·²ç»ç§»é™¤äº†è¿™ä¸ªé€‰é¡¹ã€‚
ä½ çœ‹æœ€æ–°çš„æ–‡æ¡£ï¼Œquery_and_fetch è¿™ä¸ªå‚æ•°åœ¨ search_type é‡Œé¢ä¹Ÿæ˜¯æ²¡æœ‰çš„ã€‚

# 12ã€ã€åšå®¢ã€‘èŠèŠELASTICSEARCHçš„é›†ç¾¤çŠ¶æ€çš„ç®¡ç†å’Œç»´æŠ¤

https://elasticsearch.cn/article/711

http://vearne.cc/archives/616

# 13ã€filebeatå†™å…¥1500wæ•°æ®åˆ°es
æ‰‹å¤´éœ€æ±‚æ˜¯å†™å…¥1500Wæ¡jsonæ•°æ® æ¯æ¡æ•°æ®800ä¸ªå­—æ®µ 10000æ¡jsonæ–‡ä»¶æ•°æ®ç°åœ¨æ˜¯90Må·¦å³ï¼Œç°åœ¨å¤åˆ¶å‡º100ä»½ï¼Œç”¨filebeatæ‰«æè¿›esï¼Œ esé…äº†4å°ï¼Œç”±äºç°åœ¨æ‰‹å¤´æ²¡ç‰©ç†æœºèµ„æºï¼Œåªèƒ½åœ¨4å°2gå†…å­˜çš„è™šæ‹Ÿæœº... ç„¶åç°åœ¨çš„å†™å…¥é€Ÿåº¦å¾ˆå ªå¿§ï¼Œæµ‹äº†ä¸‹ å¹³å‡ 0.92m/s 180æ¡/sï¼Œè¿™è¦æåˆ°1500wæ¡å¤ªæ…¢äº†ï¼Œ ä¸çŸ¥æ˜¯è™šæ‹Ÿæœºå†…å­˜çš„å½±å“å¤§ è¿˜æ˜¯filebeatå†™å…¥esæ²¡å¼€å¯bulkå†™å…¥ï¼Ÿè¿˜æ˜¯filebeatæœ¬èº«æ€§èƒ½ç“¶é¢ˆ

medcl - Elastic ğŸ‡¨ğŸ‡³ ï¼
è‡ªå·±å†™ç¨‹åºå¯èƒ½è¿˜æ›´å¿«ç‚¹ï¼ŒFilebeat ä¸æ˜¯ç”¨æ¥æ‰¹é‡å¯¼å…¥æ•°æ®çš„

# 14ã€esæŸ¥è¯¢ç»“æœ ä¿å­˜æˆ–è€…ä¸‹è½½
esæˆ–è€…kibanaï¼Œå°†æŸ¥è¯¢åˆ°çš„ç»“æœï¼Œä¿å­˜åˆ°æ–‡ä»¶æˆ–è€…ä¸‹è½½ï¼Œæœ‰ç±»ä¼¼çš„æ¥å£æˆ–è€…åŠŸèƒ½å—ï¼Ÿ
éº»çƒ¦äº†è§£çš„å¤§ç¥ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹

kibana 5.5åŠä»¥ä¸Š æœ‰reportå¯¼å‡ºåŠŸèƒ½ https://www.elastic.co/guide/en/kibana/5.5/xpack-reporting.html
å…¶ä»–ç‰ˆæœ¬ ç”¨es scan scroll æ–¹å¼è‡ªå·±å¯¼å‡ºå§

# 15ã€kibanaæ—¶åŒºé—®é¢˜
é—®é¢˜æ¦‚è¿°ï¼š
       æ¶æ„æ˜¯ï¼šfilebeat>es>kibana
       éœ€æ±‚ï¼šä½¿ç”¨filebeatæ¨¡å—é‡‡é›†åˆ†ænginxï¼Œaccess/erroræ—¥å¿—
       åœ¨é‡‡é›†accessæ—¥å¿—çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ—¶åŒºã€å­—æ®µç­‰æ•°æ®éƒ½æ­£å¸¸ï¼Œä½†åœ¨é‡‡é›†erroræ—¥å¿—çš„æ—¶å€™ï¼Œå‘ç°kibanaå±•ç¤ºçš„æ—¶é—´æ¯”å®é™…æ—¥å¿—æ—¶é—´å¿«8ä¸ªå°æ—¶ã€‚éšåçœ‹äº†ä¸‹accessçš„æ—¥å¿—æ ¼å¼â€œ03/Jul/2018:00:00:01 +0800â€åé¢æœ‰ä¸ª+0800ï¼Œæ‰€ä»¥kibanaå±•ç¤ºçš„æ—¶å€™æ˜¯æ­£å¸¸çš„ï¼Œè€Œerrorçš„æ—¥å¿—æ ¼å¼ä¸ºï¼šâ€œ2018/06/19 09:10:15â€ï¼Œå°±å¯¼è‡´äº†kibanaå±•ç¤ºçš„æ—¶é—´æ¯”å®é™…æ—¥å¿—æ—¶é—´å¿«8ä¸ªå°æ—¶ï¼Œå› ä¸ºåé¢æ²¡æœ‰æ—¶åŒºçš„å‚æ•°ã€‚è¯·é—®å„ä½æ€ä¹ˆå»è§£å†³ï¼Ÿç½‘ä¸Šè¯´çš„ä¿®æ”¹kibanaæ—¶åŒºï¼Œæ”¹äº†shanghaiï¼Œé‡æ–°åŠ ç´¢å¼•ï¼Œä¾ç„¶æ²¡æœ‰è§£å†³ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯filebeatçš„nginxæ¨¡å—ï¼Œèƒ½ä¸èƒ½åœ¨ä¸ä¿®æ”¹æ—¥å¿—æ ¼å¼ï¼Œä¸åŠ¨å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿä»¥ä¸‹æ˜¯ç›¸å…³æˆªå›¾ï¼š
       
https://elasticsearch.cn/question/4754


æ›´æ”¹ /usr/share/filebeat/module/nginx/error/ingest/pipeline.json æ–‡ä»¶
 
{
    "date": {
      "field": "nginx.error.time",
      "target_field": "@timestamp",
      "formats": ["YYYY/MM/dd H:m:s"],
      "timezone": "Asia/Shanghai"
    }
}

 è®¾ç½®ä¸€ä¸‹timezoneå°±å¯ä»¥äº†
 
https://www.elastic.co/guide/e ... .html

# 16ã€ogstashå¦‚ä½•åˆ¤æ–­æ•°æ®ç±»å‹
æˆ‘æ”¶åˆ°çš„æ•°æ®ä¸»è¦æ˜¯jsonçš„ï¼Œjsoné‡Œé¢çš„å­—æ®µä¼šå­˜åœ¨å­ä¸²ï¼Œç”±äºå†å²åŸå› ï¼Œè¿™äº›å­ä¸²æœ‰äº›æ˜¯jsonçš„ï¼Œæœ‰äº›æ˜¯ä¸ªstringç±»å‹çš„å­—ç¬¦ä¸²ã€‚å¦‚ä½•åˆ¤æ–­å­—æ®µç±»å‹ï¼Œç„¶åå¦‚æœæ˜¯stringç±»å‹çš„å°±å¯ä»¥ç”¨jsonè½¬åŒ–äº†ï¼Œå¦‚æœæ˜¯jsonç±»å‹çš„å°±ä¸éœ€è¦è½¬æ¢ã€‚

å¦‚æœæ˜¯ json ç±»å‹çš„ï¼Œé‚£ä¹ˆä½ å»åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ª key æ˜¯å¦å­˜åœ¨å³å¯ï¼Œä¸å­˜åœ¨åˆ™ä¸ºå­—ç¬¦ä¸²
 
if ![json_str][key_must_exist] {
      # å­—ç¬¦ä¸²ï¼Œåš json è§£æ
}

# 17ã€elasticå¦‚ä½•åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ

æ–¹å¼ä¸€ï¼š

```
curl -XPOST 'localhost:9200/test/type1/1/_update' -d '{
    "script" : "ctx._source.remove(\"name_of_field\")"
}'
```

æ–¹å¼äºŒï¼š
æ­¥éª¤1ï¼š

```
POST _reindex
{
  "source": {
    "index": "old_index"
  },
  "dest": {
    "index": "new_index"
  },
  "script": {
    "inline": """
    if (ctx._type == "bad_type") {
      ctx._source.remove("bad_field");
    }
"""
  }
}
```

æ­¥éª¤2ï¼š

```
POST /_aliases
{
  "actions": [
    {
      "add": {
        "index": "new_index",
        "alias": "old_index"
      }
    },
    {
      "remove_index": {
        "index": "old_index"
      }
    }
  ]
}
```

# 18ã€ã€å°‘è§å¤šæ€ªã€‘esé‡Œå­˜åœ¨å®Œå…¨ç›¸åŒä¸¤æ¡è®°å½•
åœ¨esé‡Œå‘ç°å­˜åœ¨å®Œå…¨ç›¸åŒçš„ä¸¤æ¡è®°å½•ï¼Œ_indexç›¸åŒï¼Œ_typeç›¸åŒï¼Œ_idä¹Ÿç›¸åŒï¼Œè¯·é—®è¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Ÿæœ‰äººé‡åˆ°è¿‡å—ï¼Ÿ

å¯èƒ½çš„bug ï¼šhttps://github.com/elastic/elasticsearch/issues/31976#issuecomment-404722753

# 19ã€esç´¢å¼•æ¨¡æ¿-æœªçŸ¥å­—æ®µæ€ä¹ˆè®¾ç½®é»˜è®¤ç±»å‹

https://elasticsearch.cn/question/4958
dynamic template
ä½ å¯ä»¥å‚è€ƒä¸‹å®˜æ–¹ filebeat monitor ç­‰é‡Œé¢ çš„ templateï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ª
{
```
"dynamic_templates": [
          {
            "disabled_payload_fields": {
              "match_pattern": "regex",
              "path_match": """result\.(input(\..+)*|(transform(\..+)*)|(actions\.transform(\..+)*))\.payload""",
              "mapping": {
                "type": "object",
                "enabled": false
              }
            }
          }]}
```


å…³æ³¨ï¼šé“­æ¯…å¤©ä¸‹å…¬ä¼—å·ï¼ æ›´çŸ­æ—¶é—´æ›´å¿«ä¹ å¾—æ›´å¤šELK Stackå¹²è´§ï¼
